<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosilico Core Architecture</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        h1 {
            color: #2563eb;
            margin-bottom: 0.5rem;
            font-size: 2.5rem;
        }
        .subtitle {
            color: #64748b;
            font-size: 1.25rem;
            margin-bottom: 2rem;
        }
        .section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        h2 {
            color: #1e40af;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0;
        }
        h3 {
            color: #475569;
            margin: 1.5rem 0 0.75rem;
        }
        .mermaid {
            margin: 1rem 0;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 1rem;
        }
        .comparison-col {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 8px;
        }
        .comparison-col.old {
            border-left: 4px solid #ef4444;
        }
        .comparison-col.new {
            border-left: 4px solid #22c55e;
        }
        .comparison-col h4 {
            color: #1e293b;
            margin-bottom: 1rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        th {
            background: #f1f5f9;
            font-weight: 600;
            color: #475569;
        }
        tr:hover {
            background: #f8fafc;
        }
        code {
            background: #f1f5f9;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.9em;
            color: #7c3aed;
        }
        .target-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        .target-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }
        .target-card h4 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        .target-card p {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        .use-case-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-top: 1rem;
        }
        .use-case {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .use-case h4 {
            color: #2563eb;
            margin-bottom: 0.5rem;
        }
        .use-case .metric {
            font-size: 1.5rem;
            font-weight: 700;
            color: #059669;
            margin: 0.5rem 0;
        }
        .feature-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        .feature {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }
        .feature-icon {
            width: 24px;
            height: 24px;
            background: #22c55e;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }
        @media (max-width: 768px) {
            .comparison, .target-grid, .use-case-grid, .feature-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Cosilico Core</h1>
        <p class="subtitle">Next-Generation Policy Rules Engine Architecture</p>

        <div class="section">
            <h2>System Architecture</h2>
            <div class="mermaid">
flowchart TB
    subgraph Definition["üìù Definition Layer"]
        V["@variable<br/>Variables"]
        P["@parameter<br/>Parameters"]
        E["@entity<br/>Entities"]
    end

    subgraph Analysis["üîç Analysis Layer"]
        Parse["Parser<br/>(Python AST)"]
        DAG["Dependency<br/>Graph"]
        Type["Type<br/>Checker"]
        Period["Period<br/>Validator"]
    end

    subgraph Optimization["‚ö° Optimization Layer"]
        DCE["Dead Code<br/>Elimination"]
        CF["Constant<br/>Folding"]
        CSE["Common Subexpr<br/>Elimination"]
    end

    subgraph Generation["üéØ Generation Layer"]
        PY["Python<br/>(NumPy)"]
        JS["JavaScript<br/>(Browser)"]
        WASM["WASM<br/>(Native)"]
        SQL["SQL<br/>(Batch)"]
        Spark["Spark<br/>(Distributed)"]
    end

    V --> Parse
    P --> Parse
    E --> Parse
    Parse --> DAG
    DAG --> Type
    Type --> Period
    Period --> IR1["Validated IR"]
    IR1 --> DCE
    DCE --> CF
    CF --> CSE
    CSE --> IR2["Optimized IR"]
    IR2 --> PY
    IR2 --> JS
    IR2 --> WASM
    IR2 --> SQL
    IR2 --> Spark

    style Definition fill:#e0f2fe
    style Analysis fill:#fef3c7
    style Optimization fill:#fce7f3
    style Generation fill:#dcfce7
            </div>
        </div>

        <div class="section">
            <h2>Compilation Targets</h2>
            <div class="target-grid">
                <div class="target-card" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                    <h4>üêç Python</h4>
                    <p>NumPy vectorized code for microsimulation</p>
                </div>
                <div class="target-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    <h4>üìú JavaScript</h4>
                    <p>Browser calculators, no backend needed</p>
                </div>
                <div class="target-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);">
                    <h4>‚ö° WASM</h4>
                    <p>Near-native performance in browser</p>
                </div>
                <div class="target-card" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">
                    <h4>üóÑÔ∏è SQL</h4>
                    <p>Batch processing in data warehouses</p>
                </div>
                <div class="target-card" style="background: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%);">
                    <h4>üî• Spark</h4>
                    <p>Distributed computing at scale</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Use Cases & Performance Targets</h2>
            <div class="use-case-grid">
                <div class="use-case">
                    <h4>üè† Real-Time API</h4>
                    <div class="metric">&lt; 100ms</div>
                    <p>Single household calculation for web apps and APIs. Sub-second response times.</p>
                </div>
                <div class="use-case">
                    <h4>üìä Microsimulation</h4>
                    <div class="metric">1M/sec</div>
                    <p>Process millions of households for policy analysis on commodity hardware.</p>
                </div>
                <div class="use-case">
                    <h4>üåê Census Scale</h4>
                    <div class="metric">100M/hr</div>
                    <p>Full population modeling with distributed computing clusters.</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Entity Hierarchy Model</h2>
            <div class="mermaid">
flowchart BT
    Person["üë§ Person"]
    TaxUnit["üìã Tax Unit"]
    Household["üè† Household"]
    SPMUnit["üìä SPM Unit"]
    State["üó∫Ô∏è State"]

    Person -->|"sum, any, max"| TaxUnit
    Person -->|"sum, any, max"| Household
    Person -->|"sum, any, max"| SPMUnit
    TaxUnit -->|"sum"| Household
    Household -->|"sum"| State

    TaxUnit -.->|"broadcast"| Person
    Household -.->|"broadcast"| Person
    State -.->|"broadcast"| Household
            </div>
            <p style="margin-top: 1rem; color: #64748b;">
                <strong>Solid arrows:</strong> Aggregation (child ‚Üí parent) &nbsp;&nbsp;
                <strong>Dashed arrows:</strong> Broadcasting (parent ‚Üí child)
            </p>
        </div>

        <div class="section">
            <h2>OpenFisca vs Cosilico Comparison</h2>
            <div class="comparison">
                <div class="comparison-col old">
                    <h4>‚ùå OpenFisca/PE-Core</h4>
                    <ul style="list-style: none; padding: 0;">
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid #e2e8f0;">
                            <strong>Dependencies:</strong> Discovered at runtime via recursion
                        </li>
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid #e2e8f0;">
                            <strong>Type checking:</strong> Runtime coercion, silent errors
                        </li>
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid #e2e8f0;">
                            <strong>Memory:</strong> Full clone per scenario/reform
                        </li>
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid #e2e8f0;">
                            <strong>Targets:</strong> Python only
                        </li>
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid #e2e8f0;">
                            <strong>Periods:</strong> Implicit STOCK/FLOW conversion
                        </li>
                        <li style="padding: 0.5rem 0;">
                            <strong>License:</strong> AGPL (viral, enterprise-hostile)
                        </li>
                    </ul>
                </div>
                <div class="comparison-col new">
                    <h4>‚úÖ Cosilico Core</h4>
                    <ul style="list-style: none; padding: 0;">
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid #e2e8f0;">
                            <strong>Dependencies:</strong> Compile-time DAG analysis
                        </li>
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid #e2e8f0;">
                            <strong>Type checking:</strong> Static validation at compile time
                        </li>
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid #e2e8f0;">
                            <strong>Memory:</strong> Copy-on-write semantics
                        </li>
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid #e2e8f0;">
                            <strong>Targets:</strong> Python, JS, WASM, SQL, Spark
                        </li>
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid #e2e8f0;">
                            <strong>Periods:</strong> Explicit type in signature
                        </li>
                        <li style="padding: 0.5rem 0;">
                            <strong>License:</strong> Apache 2.0 (permissive)
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Intermediate Representation (IR)</h2>
            <div class="mermaid">
flowchart LR
    subgraph Inputs
        I1["IRInput<br/>wages"]
        I2["IRInput<br/>interest"]
    end

    subgraph Params
        P1["IRParam<br/>brackets"]
        P2["IRParam<br/>exemption"]
    end

    subgraph Computation
        A1["IRBinaryOp<br/>ADD"]
        A2["IRBinaryOp<br/>SUB"]
        B1["IRBracketCalc<br/>MARGINAL"]
    end

    subgraph Output
        O1["income_tax"]
    end

    I1 --> A1
    I2 --> A1
    A1 --> A2
    P2 --> A2
    A2 --> B1
    P1 --> B1
    B1 --> O1
            </div>
            <table style="margin-top: 1rem;">
                <thead>
                    <tr>
                        <th>IR Node Type</th>
                        <th>Description</th>
                        <th>Example</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>IRInput</code></td>
                        <td>Input variable from situation</td>
                        <td>wages, age, is_married</td>
                    </tr>
                    <tr>
                        <td><code>IRParam</code></td>
                        <td>Parameter lookup</td>
                        <td>gov.irs.income.brackets</td>
                    </tr>
                    <tr>
                        <td><code>IRBinaryOp</code></td>
                        <td>Binary operation (+, -, *, /, etc.)</td>
                        <td>wages + interest</td>
                    </tr>
                    <tr>
                        <td><code>IRConditional</code></td>
                        <td>If-then-else</td>
                        <td>where(age >= 65, ...)</td>
                    </tr>
                    <tr>
                        <td><code>IRAggregation</code></td>
                        <td>Entity aggregation</td>
                        <td>tax_unit.sum(wages)</td>
                    </tr>
                    <tr>
                        <td><code>IRBroadcast</code></td>
                        <td>Entity broadcast</td>
                        <td>person.household.rent</td>
                    </tr>
                    <tr>
                        <td><code>IRBracketCalc</code></td>
                        <td>Bracket/scale calculation</td>
                        <td>brackets.calc(agi)</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="section">
            <h2>Key Features</h2>
            <div class="feature-list">
                <div class="feature">
                    <div class="feature-icon">‚úì</div>
                    <div>
                        <strong>Static Dependency Analysis</strong>
                        <p style="color: #64748b; font-size: 0.9rem;">Build complete DAG at compile time, enabling optimal execution order and parallelization.</p>
                    </div>
                </div>
                <div class="feature">
                    <div class="feature-icon">‚úì</div>
                    <div>
                        <strong>Multi-Target Compilation</strong>
                        <p style="color: #64748b; font-size: 0.9rem;">Generate Python, JavaScript, WASM, SQL, or Spark from a single rule definition.</p>
                    </div>
                </div>
                <div class="feature">
                    <div class="feature-icon">‚úì</div>
                    <div>
                        <strong>Copy-on-Write Memory</strong>
                        <p style="color: #64748b; font-size: 0.9rem;">Efficient scenario analysis without duplicating entire datasets.</p>
                    </div>
                </div>
                <div class="feature">
                    <div class="feature-icon">‚úì</div>
                    <div>
                        <strong>Type-Safe Rules</strong>
                        <p style="color: #64748b; font-size: 0.9rem;">Catch type errors at definition time, not during production calculations.</p>
                    </div>
                </div>
                <div class="feature">
                    <div class="feature-icon">‚úì</div>
                    <div>
                        <strong>Explicit Period Handling</strong>
                        <p style="color: #64748b; font-size: 0.9rem;">Period types in signatures prevent subtle time-related bugs.</p>
                    </div>
                </div>
                <div class="feature">
                    <div class="feature-icon">‚úì</div>
                    <div>
                        <strong>Multi-Level Entity Hierarchy</strong>
                        <p style="color: #64748b; font-size: 0.9rem;">Support arbitrary entity relationships beyond simple person ‚Üí group.</p>
                    </div>
                </div>
                <div class="feature">
                    <div class="feature-icon">‚úì</div>
                    <div>
                        <strong>Explainable Calculations</strong>
                        <p style="color: #64748b; font-size: 0.9rem;">Generate human-readable explanations for audit and compliance.</p>
                    </div>
                </div>
                <div class="feature">
                    <div class="feature-icon">‚úì</div>
                    <div>
                        <strong>Permissive License</strong>
                        <p style="color: #64748b; font-size: 0.9rem;">Apache 2.0 enables enterprise adoption and embedding in commercial products.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Development Roadmap</h2>
            <div class="mermaid">
gantt
    title Cosilico Core Development Timeline
    dateFormat  YYYY-MM
    section Core
    IR Data Structures     :done, 2024-12, 2025-01
    Python Parser          :active, 2025-01, 2025-02
    Type Checker           :2025-02, 2025-03
    section Entities
    Entity Hierarchy       :2025-02, 2025-03
    Aggregation/Broadcast  :2025-03, 2025-04
    section Targets
    Python Generator       :2025-03, 2025-04
    JavaScript Generator   :2025-04, 2025-05
    SQL Generator          :2025-05, 2025-06
    section Scale
    Spark Generator        :2025-06, 2025-07
    Memory Management      :2025-07, 2025-08
    Production Ready       :milestone, 2025-08, 0d
            </div>
        </div>

        <div class="section" style="background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); color: white;">
            <h2 style="color: white; border-color: rgba(255,255,255,0.2);">Get Involved</h2>
            <p style="font-size: 1.1rem; margin-bottom: 1rem;">
                Cosilico Core is open source under Apache 2.0. We're looking for contributors interested in:
            </p>
            <ul style="list-style: none; padding: 0; display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                <li>üîß Compiler design and optimization</li>
                <li>üìä Policy modeling and tax/benefit expertise</li>
                <li>üåê JavaScript/WASM code generation</li>
                <li>üìà Distributed computing (Spark, Dask)</li>
                <li>üî¨ Type systems and static analysis</li>
                <li>üìù Documentation and examples</li>
            </ul>
            <p style="margin-top: 1.5rem;">
                <a href="https://github.com/cosilico/cosilico-core" style="color: #60a5fa; text-decoration: none;">
                    GitHub Repository ‚Üí
                </a>
            </p>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            gantt: {
                titleTopMargin: 25,
                barHeight: 20,
                barGap: 4,
                topPadding: 50,
                sidePadding: 50
            }
        });
    </script>
</body>
</html>
